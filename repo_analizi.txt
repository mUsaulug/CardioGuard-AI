şağıda, CardioGuard-AI deposundaki dört ana “rehber” dosya (PROJECT_*) başta olmak üzere kod, metrikler, JSON/CSV çıktılar, test sonuçları ve görsel XAI artefaktlarının tamamı esas alınarak hazırlanmış kapsamlı teknik denetim raporu yer almaktadır. Rapor dili tamamen Türkçe olup; mimari, veri hattı, eğitim/val/test metrikleri, eşik stratejileri, XAI bileşenleri, klinik kullanım değerleri ve risk analizi detaylı şekilde kapsanmıştır.

Kapsama giren ana referanslar:
PROJECT_LLM_PROMPT.md, PROJECT_MASTER_ANALYSIS.md, PROJECT_TECHNICAL_DEEP_DIVE.md, PROJECT_BINARY_ANALYSIS.md
(dosya içerikleri rapor boyunca alıntılanmış ve karşılaştırılmıştır).
Kaynaklar: PROJECT_LLM_PROMPT.md, PROJECT_MASTER_ANALYSIS.md, PROJECT_TECHNICAL_DEEP_DIVE.md, PROJECT_BINARY_ANALYSIS.md
(Komut: sed -n '1,200p' ...)

1) Özet: Projenin Amacı ve Klinik Hedef
CardioGuard-AI, PTB-XL tabanlı, çoklu etiketli ECG sınıflandırma + MI lokalizasyonu + XAI sağlayan hibrit (CNN + XGBoost) bir klinik karar destek sistemidir. Hedef sınıflar: MI, STTC, CD, HYP, NORM; MI pozitifliğinde ayrıca anatomik bölge lokalizasyonu (AMI, ASMI, ALMI, IMI, LMI) üretilir. Projenin birincil klinik hedefi MI için yüksek duyarlılık, ikincil hedefi ise açıklanabilir ve klinik güvenilir raporlamadır.
Kaynaklar: PROJECT_LLM_PROMPT.md, PROJECT_MASTER_ANALYSIS.md, PROJECT_TECHNICAL_DEEP_DIVE.md

2) Proje Mimari Özeti (Sentez)
2.1 CNN Omurga (1D-ResNet benzeri)
Model omurgası 1D Conv tabanlıdır. ECGBackbone, 12 kanal girişten 64-boyutlu embedding çıkarır (Conv1d + BN + ReLU + Dropout + AdaptiveAvgPool1d).
Kaynak: src/models/cnn.py

2.2 Superclass Multi-label CNN
MultiLabelECGCNN 4 patoloji sınıfına (MI, STTC, CD, HYP) ait logits üretir. NORM etiketini türetilmiş (patoloji yoksa NORM=1) olarak ele alır.
Kaynak: src/pipeline/train_superclass_cnn.py, src/data/labels_superclass.py

2.3 XGBoost OVR
CNN’den çıkarılan 64-dim embedding’ler ile OVR (One-vs-Rest) XGBoost modelleri eğitilir (MI/STTC/CD/HYP). Her sınıf için kalibrasyon (sigmoid/isotonic) uygulanır.
Kaynak: src/pipeline/train_superclass_xgb_ovr.py, logs/xgb_superclass/training_results.json

2.4 Ensemble (Hibrit)
CNN ve XGB çıktıları ağırlıklı ortalama ile birleştirilir:
P_final = w * P_cnn + (1-w) * P_xgb
Varsayılan w = 0.5 olup ensemble_config.json en iyi α değerinin 0.15 olduğunu gösterir.
Kaynak: src/pipeline/run_inference_superclass.py, reports/ensemble_config.json

3) Veri ve Etiketleme Katmanı
3.1 Veri Doğrulama (PTB-XL)
verification_output.txt veri katmanı doğrulama çıktıları:

Toplam 21,799 kayıt

18,869 hasta

71 SCP statement

Binary MI vs NORM dağılımı (excluded / NORM / MI)
Dosyada UTF-16/NULL byte sorunu var; yine de metrikler okunabilir.
Kaynak: verification_output.txt

3.2 Sınıf Dağılımı ve Multi-label İstatistikler
Train örnek: 17,418

Ortalama etiket: 1.268

Çoklu etiketli örnek: 4,069

En dengesiz sınıf: HYP (pozitif oran ~0.12)
Kaynak: reports/data_validation/class_distribution.json, reports/superclass_labels/superclass_label_report.json

3.3 NORM Etiketi (Türetilmiş)
labels_superclass.py NORM’u doğrudan SCP’den değil, patoloji yoksa türetir. Bu, NORM’un patolojilerle birlikte görülmemesini garanti eder (norm_check PASS).
Kaynak: src/data/labels_superclass.py, reports/superclass_labels/superclass_label_report.json

4) Eğitim & Validasyon & Test Metrikleri
4.1 Binary CNN (Legacy)
logs/cnn/metrics.json test sonuçları:

ROC-AUC: 0.9724

PR-AUC: 0.9447

F1: 0.8419

Accuracy: 0.9282
Kaynak: logs/cnn/metrics.json

4.2 Superclass CNN (Multi-label)
logs/superclass_cnn/training_results.json test metrikleri:

Macro AUROC: 0.8986

Macro AUPRC: 0.7308

Macro F1: 0.6302

Hamming Acc: 0.8051
Per-class F1: MI=0.693, STTC=0.664, CD=0.679, HYP=0.484
Kaynak: logs/superclass_cnn/training_results.json

4.3 Binary XGBoost (Legacy)
logs/xgb/metrics.json test:

ROC-AUC: 0.9763

PR-AUC: 0.9497

F1: 0.8664
Best threshold (val): 0.8
Kaynak: logs/xgb/metrics.json

4.4 Superclass XGBoost OVR
logs/xgb_superclass/training_results.json:

MI AUROC 0.9024, F1 0.6968

STTC AUROC 0.9218, F1 0.7126

CD AUROC 0.8881, F1 0.6896

HYP AUROC 0.8868, F1 0.5762
Kaynak: logs/xgb_superclass/training_results.json

4.5 Ensemble Karşılaştırması
reports/comparison_report.md:

CNN: F1 0.7436

XGBoost: F1 0.7850

Ensemble (α=0.15): F1 0.8132, Accuracy 0.8765
Kaynak: reports/comparison_report.md

5) Eşikler, Kalibrasyon ve Karar Kuralları
5.1 Eşikler
artifacts/thresholds_superclass.json dosyasında varsayılan eşikler 0.5 olarak sabitlenmiş; ancak “details” bölümünde optimizasyon sonucunda MI için 0.01, STTC için ~0.418 vb. değerler bulunuyor.
Bu iki set arasında uyumsuzluk var: inference tarafı thresholds alanını kullanıyor (0.5), ama detaylar farklı.
Kaynak: artifacts/thresholds_superclass.json, src/pipeline/run_inference_superclass.py

5.2 Kalibrasyon
XGBoost çıktıları için calibrator.joblib (sigmoid/isotonic) kullanılıyor. Inference’ta calibrator varsa uygulanıyor.
Kaynak: src/pipeline/run_inference_superclass.py, src/pipeline/train_superclass_xgb_ovr.py

5.3 MI-Öncelikli Karar Kuralı
get_primary_label fonksiyonu MI eşiğini önce kontrol eder; MI pozitifse diğer patolojileri bastırır.
Kaynak: src/pipeline/run_inference_superclass.py

6) MI Lokalizasyonu (Anatomik Bölge)
Sadece MI pozitifse (predicted_labels içinde MI) lokalizasyon çalışır.

Çıktı: AMI/ASMI/ALMI/IMI/LMI olasılıkları + threshold >=0.5 bölgeler.
Kaynak: src/pipeline/run_inference_superclass.py, src/pipeline/train_mi_localization.py

7) XAI (Grad-CAM + SHAP + Unified)
7.1 Grad-CAM
GradCAM sınıfı ile CNN’in son conv bloğu üzerinden 1D heatmap üretir.
Kaynak: src/xai/gradcam.py

7.2 SHAP
shap_ovr.py OVR XGB modellerine SHAP uygular; tek örnek veya toplu analiz mümkün.
Kaynak: src/xai/shap_ovr.py

7.3 Unified Explainer
UnifiedExplainer görsel (Grad-CAM) ve istatistiksel (SHAP) kanıtı birleştirir.
Coherence score şu an heuristik (0.85) ve feature mapping “placeholder” düzeyinde.
Kaynak: src/xai/unified.py

7.4 XAI Sanity
XAISanityChecker içinde randomization/perturbation testleri var, ancak _randomize_last_layer boş, skorlar “placeholder”.
Kaynak: src/xai/sanity.py

8) Kapsamlı Test Sonuçları (15 örnek)
reports/comprehensive_test/summary_results.json örnekleri, MI recall’ın yüksek olduğunu gösterirken NORM örneklerde MI FP davranışı gözleniyor (örn. sample_id=815, sample_id=1832).
Bu, MI-öncelikli stratejinin güvenlik odaklı ama özgüllüğü düşüren etkisini doğruluyor.
Kaynak: reports/comprehensive_test/summary_results.json

9) Çıktı / Artefakt Envanteri (JSON/TXT/PNG)
9.1 JSON & CSV
logs/cnn/metrics.json

logs/superclass_cnn/training_results.json

logs/xgb/metrics.json

logs/xgb_superclass/training_results.json

reports/ensemble_config.json

reports/comparison_report.md / .csv

reports/data_validation/class_distribution.json

reports/superclass_labels/superclass_label_report.json

reports/comprehensive_test/summary_results.json / .csv

artifacts/thresholds_superclass.json

test_mi_result.json, sample_test.json
Kaynaklar: ilgili dosyalar (komutlar: sed -n '1,200p' ...)

9.2 TXT
verification_output.txt (veri doğrulama logu)
Kaynak: verification_output.txt

9.3 PNG (XAI)
reports/xai/ altında:

gradcam_sample_*, shap_waterfall_sample_*, lead_attention_sample_*, shap_summary.png, ecg_sample_*
Kaynak: reports/xai dizin listesi

10) Bileşen Bazlı Denetim (İstenen Format)
10.1 Signal Fidelity — ensure_channel_first
Durum: At Risk
Logical Flaws:

Sadece şekil heuristiği var; kanal sayısı 12 değilse yanlış transpozisyon ihtimali var.

İki ayrı yerde tekrar tanımlı (run_inference_superclass.py, train_mi_localization.py) tutarsızlık riski.
Optimization Tips:

Giriş doğrulamasını (12, 1000) sözleşmesine sabitle.

Yanlış boyutlarda açık hata ver.
Clinical Value:

Derivasyon sırası yanlışsa Grad-CAM ve klinik çıkarımlar yanlış yönlendirebilir.
Kaynaklar: src/pipeline/run_inference_superclass.py, src/pipeline/train_mi_localization.py

10.2 Calibration Integrity — XGB Kalibrasyon
Durum: Robust
Logical Flaws:

Kalibratör dosyası yoksa sessizce raw prob. kullanılabiliyor.
Optimization Tips:

Artefakt manifesti + zorunlu dosya doğrulaması eklenmeli.
Clinical Value:

Olasılıkların anlamlı skalada kalması klinik güven için kritik.
Kaynak: src/pipeline/run_inference_superclass.py, src/pipeline/train_superclass_xgb_ovr.py

10.3 Localization Safety
Durum: Robust (şartlı)
Logical Flaws:

MI pozitifliği sadece predicted_labels üzerinden kontrol ediliyor; threshold yanlış ayarlanırsa yanlış lokalizasyon üretebilir.
Optimization Tips:

Eşikler klinik protokolle sabitlenmeli ve versiyonlanmalı.
Clinical Value:

Anatomik bölge tahmini, kardiyoloğun kritik bölgeye hızla odaklanmasını sağlar.
Kaynak: src/pipeline/run_inference_superclass.py

10.4 XAI Coherence (UnifiedExplainer)
Durum: Refactor Recommended
Logical Flaws:

Coherence skor heuristik, SHAP-GradCAM eşleşmesi gerçek değil.
Optimization Tips:

Lead-özellik eşlemesi ve gerçek ölçüt eklenmeli.
Clinical Value:

Klinik raporun ikna ediciliği ve güveni artar.
Kaynak: src/xai/unified.py

10.5 MI-First Rule Performance Trade-off
Durum: At Risk
Logical Flaws:

MI eşiği geçildiğinde diğer patolojiler görmezden geliniyor.

FP örnekleri (sample 815, 1832) bu davranışı gösteriyor.
Optimization Tips:

Primary label MI olabilir, ama multi-label rapor ayrı ve açık sunulmalı.
Clinical Value:

Hasta güvenliği önceliklidir; fakat gereksiz alarm riski artar.
Kaynak: src/pipeline/run_inference_superclass.py, reports/comprehensive_test/summary_results.json

11) Ek Kritik Notlar (Kod Bazlı)
run_inference_superclass.py içinde load_localization_model fonksiyonunda nn.Module kullanılıyor ama torch.nn as nn import edilmemiş. Bu runtime hatasına yol açabilir.
Kaynak: src/pipeline/run_inference_superclass.py

DEFAULT_XGB_DIR ve UnifiedExplainer importu iki kez tanımlanmış (kod temizliği önerilir).
Kaynak: src/pipeline/run_inference_superclass.py

XAISanityChecker._randomize_last_layer boş (pass). Bu, sanity check’in gerçek doğrulama yapmadığını gösterir.
Kaynak: src/xai/sanity.py

12) Sistem Akışı (Klinik Perspektif ile Akış Özeti)
ECG sinyal yüklenir (load_ecg_signal)

ensure_channel_first ile şekil normalizasyonu

CNN logits → sigmoid → prob.

CNN embedding → XGB OVR → kalibrasyon → prob.

Ensemble ile birleşik prob.

Eşikler uygulanır, multi-label belirlenir

MI varsa lokalizasyon çalışır

Grad-CAM + SHAP + Unified XAI (opsiyonel)
Kaynak: src/pipeline/run_inference_superclass.py

13) Sonuç (Genel Değerlendirme)
CardioGuard-AI, klinik güven ve açıklanabilirlik hedeflerini merkezine alan hibrit bir ECG tanı sistemidir. Mimari olarak güçlüdür, eğitim metrikleri makuldür ve özellikle MI duyarlılığı yüksek olacak şekilde tasarlanmıştır. Ancak:

Eşik/kalibrasyon yönetimi daha deterministik hale getirilmeli.

XAI coherence gerçek metriklere dayandırılmalı.

MI-first kuralının FP etkisi klinik protokolle dengelenmeli.

Bu haliyle proje, makale/akademik raporlama için zengin veri ve metrik altyapısına sahiptir; raporda kullanılacak tüm sayısal sonuçlar ve artefaktlar depoda mevcuttur.

Kaynaklar ve İnceleme Komutları
Aşağıdaki komutlar ve dosyalar raporun tamamı için doğrudan kullanıldı:

sed -n '1,200p' PROJECT_LLM_PROMPT.md

sed -n '1,200p' PROJECT_MASTER_ANALYSIS.md

sed -n '1,200p' PROJECT_TECHNICAL_DEEP_DIVE.md

sed -n '1,200p' PROJECT_BINARY_ANALYSIS.md

sed -n '1,200p' logs/cnn/metrics.json

sed -n '1,200p' logs/superclass_cnn/training_results.json

sed -n '1,200p' logs/xgb/metrics.json

sed -n '1,200p' logs/xgb_superclass/training_results.json

sed -n '1,200p' reports/comparison_report.md

sed -n '1,200p' reports/ensemble_config.json

sed -n '1,200p' reports/data_validation/class_distribution.json

sed -n '1,200p' reports/data_validation/label_cooccurrence.csv

sed -n '1,200p' reports/superclass_labels/superclass_label_report.json

sed -n '1,200p' reports/comprehensive_test/summary_results.json

sed -n '1,200p' reports/comprehensive_test/summary_results.csv

sed -n '1,200p' verification_output.txt

sed -n '1,200p' artifacts/thresholds_superclass.json

sed -n '1,200p' test_mi_result.json

sed -n '1,200p' sample_test.json

sed -n '1,200p' src/pipeline/run_inference_superclass.py

sed -n '200,520p' src/pipeline/run_inference_superclass.py

sed -n '1,200p' src/pipeline/run_inference_binary.py

sed -n '1,200p' src/pipeline/train_superclass_xgb_ovr.py

sed -n '1,200p' src/pipeline/train_mi_localization.py

sed -n '1,200p' src/models/cnn.py

sed -n '1,200p' src/pipeline/train_superclass_cnn.py

sed -n '1,200p' src/config.py

sed -n '1,200p' src/data/labels_superclass.py

sed -n '1,200p' src/xai/gradcam.py

sed -n '1,200p' src/xai/shap_ovr.py

sed -n '1,200p' src/xai/unified.py

sed -n '1,200p' src/xai/sanity.py

ls reports / ls reports/xai / ls reports/comprehensive_test / ls logs / ls logs/xgb_superclass / ls artifacts

rg -n "calibrator|calibrat|xgb" src/pipeline/run_inference_superclass.py